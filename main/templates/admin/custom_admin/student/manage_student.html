{% extends 'base.html' %}
{% load static %}
{% block title %}Manage Student{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/admin/manage_student.css' %}">

<div class="container py-4">

  <!-- STUDENT HEADER -->
  <div class="student-header">
    <div class="student-avatar">
        {% if student.user.profile and student.user.profile.avatar %}
            <img src="{{ student.user.profile.avatar.url }}">
        {% else %}
            <span>{{ student.user.first_name|first }}</span>
        {% endif %}
    </div>


    <div>
      <h3 class="mb-0">{{ student.student_name }}</h3>
      <small class="text-muted">{{ student.course.title }}</small>
    </div>
  </div>

  <!-- STUDENT INFO -->
  <div class="card student-info-card mb-4">
    <h5 class="mb-3">Student Information</h5>

    <div class="info-grid">
      <!-- LEFT -->
      <div class="info-col">
        <p><strong>Email:</strong> {{ student.email }}</p>
        <p><strong>Phone:</strong> {{ student.phone }}</p>
        <p><strong>Gender:</strong> {{ student.gender }}</p>
      </div>

      <!-- CENTER -->
      <div class="info-col">
        <p><strong>Date of Birth:</strong> {{ student.dob }}</p>
        <p><strong>Address:</strong> {{ student.address }}</p>
        <p>
          <strong>Status:</strong>
          <span class="status {{ student.status }}">
            {{ student.status|capfirst }}
          </span>
        </p>
      </div>

      <!-- RIGHT -->
      <div class="info-col">
        <p><strong>Institute:</strong> {{ student.institute.name }}</p>
        <p><strong>Category:</strong> {{ student.category.title }}</p>
        <p><strong>Course:</strong> {{ student.course.title }}</p>
      </div>
      

    </div>
    <hr>

      <h5 class="mb-3">Payment Information</h5>

      <div class="info-grid">
        <!-- LEFT -->
        <div class="info-col">
          <p>
            <strong>Course Fee:</strong>
            Rs. {{ student.course.original_price|floatformat:2 }}
          </p>
          <p>
            <strong>Discount:</strong>
            {{ student.course.discount_percent }}%
          </p>
        </div>

        <!-- CENTER -->
        <div class="info-col">
          <p>
            <strong>Final Amount:</strong>
            Rs. {{ student.amount|floatformat:2 }}
          </p>
        </div>

        <!-- RIGHT -->
        <div class="info-col">
          <p>
            <strong>Payment Status:</strong>
            {% if student.is_paid %}
                <span class="badge bg-success">PAID</span>
            {% else %}
                <span class="badge bg-danger">UNPAID</span>
            {% endif %}
          </p>
        </div>
      </div>
  </div>

  <!-- ACTION BUTTONS -->
  <form method="POST" class="action-buttons">
    {% csrf_token %}
    <button type="submit" name="action" value="shortlist" class="btn btn-warning">Shortlist</button>
    <button type="submit" name="action" value="accept" class="btn btn-success">Accept</button>
    <button type="submit" name="action" value="reject" class="btn btn-danger">Reject</button>
  </form>

  <!-- DOCUMENTS -->
  <div class="card p-3">
    <h5 class="mb-3">Uploaded Documents</h5>

    {% if student.documents.all.count %}
      <div class="row g-3">
        {% for doc in student.documents.all %}
          <div class="col-auto text-center">
            <strong>{{ doc.doc_type }}</strong><br>

            {% with doc.file.url|lower as f %}
              {% if ".jpg" in f or ".jpeg" in f or ".png" in f or ".webp" in f %}
                <img src="{{ doc.file.url }}"
                     class="doc-thumb"
                     data-full="{{ doc.file.url }}">
              {% else %}
                <a href="{{ doc.file.url }}" target="_blank" class="btn btn-secondary btn-sm mt-2">
                  View File
                </a>
              {% endif %}
            {% endwith %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">No documents uploaded.</p>
    {% endif %}
  </div>
</div>

<!-- IMAGE PREVIEW MODAL -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-body text-center">
        <img id="modalPreviewImage" class="img-fluid rounded">
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const modal = new bootstrap.Modal(document.getElementById("imagePreviewModal"));
  const modalImg = document.getElementById("modalPreviewImage");

  document.querySelectorAll(".doc-thumb").forEach(img => {
    img.addEventListener("click", () => {
      modalImg.src = img.dataset.full;
      modal.show();
    });
  });
});
</script>

{% endblock %}
